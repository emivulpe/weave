{% extends 'exerciser/teacher_interface_base.html' %}
{% load static %}
{% block links %} 	
	<link rel="stylesheet" type="text/css" href="{% static 'css/ui.dropdownchecklist.themeroller.css' %}" />
	<link rel="stylesheet" type="text/css" href="{% static 'css/jquery-ui-1.8.4.custom.css' %}" />
	{% endblock %}
{% block style %}
	<style>
		#container{
			min-width: 310px;
			height: 400px;
			margin: 0 auto;
		}
		.ui-autocomplete{
			margin:0;
			padding:0;
			width:100px;

		}
		
		.ui-menu-item{
			list-style-type:none;

		}
	</style>
{% endblock %}

{% block body_block %}
<div class="container" style="background:gray;width: 100%;">
	<select id="group_year" class="year choice_selector">
		<option value="" disabled selected style="display:none;">Select academic year...</option>
		{% for year in academic_years %}
			<option value="{{year.start}}" >{{ year.start}}/{{ year.start|add:"1" }}</option>
		{% endfor %}
	</select>
	<select id="group_list" class="group choice_selector">
	</select>

	<select id="statistics_options" class="choice_selector">
		<option id="stats_info" value="" disabled selected>Select data type...</option>
		<option value="time">Average Time</option>
		<option value="answers">Question Answers</option>
		<option value="summary_data">Class Summary</option>
		<option value="class_steps">Class Steps</option>
	</select>
	<span class="ui-widget">
		<input id="application" class="choice_selector" placeholder="Select application...">
	</span>

	<select id="question_list" class="choice_selector" style="max-width:200px;display:none;">
		<option id="question_info" value="" disabled selected>Select question...</option>
	</select>
	<select id="s1" multiple="multiple">
    <option value="a">Alice</option>
    <option value="b">Bob</option>
    <option value="c">Christian</option>
    <option value="d">Daniel</option>
</select>
	<button id="set_data_button" class="autocompare choice_selector">View data</button>
	<i class="fa fa-info-circle"></i><span class="landing-text">Please select!</span>
</div>
	<div id="container" style="width:100%; min-height:80vh; text-align: center;font-size: 12pt; font-weight: bold;"> </div>
	
	<table id="summary_data" border="1" style="display:none;">
		<caption id="summary_data_caption" style="text-align: center;">test</caption>
		<tr>
			<th>Student ID</th>
			<th>Total time</th>
			<th>Times revisited</th>
			<th>Last step</th>
		</tr>
	</table>

{% endblock %}

{% block javascripts %}
	<script src="/static/js/highcharts.js"></script>
	<script src="/static/js/exporting.js"></script>
	<script src="/static/js/customEvents.js"></script>

<script src="http://code.highcharts.com/modules/data.js"></script>


<!-- Additional files for the Highslide popup effect -->
<script type="text/javascript" src="http://www.highcharts.com/media/com_demo/highslide-full.min.js"></script>
<script type="text/javascript" src="http://www.highcharts.com/media/com_demo/highslide.config.js" charset="utf-8"></script>
<script type="text/javascript" src="/static/js/jquery-ui.js"></script>
<script type="text/javascript" src="/static/js/ui.dropdownchecklist-1.1-min.js"></script>
<link rel="stylesheet" type="text/css" href="http://www.highcharts.com/media/com_demo/highslide.css" />

	<script>

		{% autoescape off %}
		var app_questions_dict = {{app_questions_dict}};
		var applications = {{application_names}};
		var year_group_dict = {{groups}}
		{% endautoescape %}
		var apps_without_questions=[];
		var apps_with_questions=[];
		var legal_applications=applications; //apps that are good for the selected category (questions, average time)
		var selected_option="";
		populateGroupList("group_year","group_list");

		for (var application in app_questions_dict) {
			if (app_questions_dict[application].length == 0){
				apps_without_questions.push(application);
			}
			else{
				apps_with_questions.push(application);
			}
		}
		console.log(apps_without_questions);

		
function getStepData(step){
	selected_application=$("#application").val();
	console.log(selected_application+"TEST APPP");
	selected_group=document.getElementById("group_list").value;
	var selected_year = document.getElementById("group_year").value
	var request = $.get('/exerciser/get_step_data/',
	{	
		application:selected_application,
		group:selected_group, 
		step:step,
		year:selected_year
	});
	request.done(function(selected_data) {
		console.log(selected_data);
		var option_categories=[];
		var option_data=[];
		for (i = 0; i < selected_data.length; i++) { 
			console.log(selected_data[i]+"SELDI");
			for (var option in selected_data[i]) {
				console.log(option+"OPTION");
				if ((typeof option)=="string" && option!="students"){
					option_categories.push(option);
					option_data.push({"y":selected_data[i][option]});
				}
			}
		}
       var chart = $('#container').highcharts();
       chart.series[0].setData(option_data);
	});
}
		var count=0;
		var step=0;
		
		
		function getNextStepData() {
			step++;
			console.log(step);
			getStepData(step);
		};
		
		function getPrevStepData() {
			step--;
			console.log(step);
			getStepData(step);
		};
		$(function () {
		
			selected_application=$("#application").val();
			selected_group=document.getElementById("group_list").value;
			

			console.log(selected_option + selected_application + selected_group);
			
			
			/*$('#application_list').on('change', function() {
				selected_application = document.getElementById("application_list").value;
				if(selected_option=="answers"){
					$("#question_list").empty();
					addQuestions(selected_application);
				}
			});
			
			$('#group_list').on('change', function() {
				selected_group = document.getElementById("group_list").value;
			});
			*/
			$('#statistics_options').on('change', function() {
				selected_option = document.getElementById("statistics_options").value;
				$("#application").val('');
				if (this.value=="answers"){
					$("#question_list").show();
					/*$( this ).after( "<select id='question_list' style='max-width:250px;margin: 10px 5px 10px 10px; padding: 5px; font-size: 12pt; font-weight: bold;'><option value='' disabled selected style='display:none;'>Select question...</option></select>" );
					for (var index in apps_without_questions) {
							$("#id_"+apps_without_questions[index]).wrap('<span/>'); //hide it-no questions (cross-browser compatible)
					}
					*/
					//legal_applications=apps_with_questions;
					//remove apps without questions, when enter app, on click of this show relevant questions, before that Select question...
				/*	$("#application_list > option:first").attr("selected", "selected"); 
					selected_application = document.getElementById("application_list").value;
					console.log("Sel app" + selected_application);
					console.log($("#application_list > option:first").val()+"FC");
					*/
					
					$( "#application" ).autocomplete('option', 'source', apps_with_questions);

				}
				
				else{
					//legal_applications=applications;
					$( "#application" ).autocomplete('option', 'source', applications);
					$("#question_list").hide();
					/*if ($("#question_list").length > 0){
						$("#question_list").remove();
					}
					
					for (var index in apps_without_questions) {
						$("#id_"+apps_without_questions[index]).unwrap(); //hide it-no questions (cross-browser compatible)
					}*/
				}
			});

$( "#application" ).blur(function() {
	if (selected_option=="answers"){
		selected_application=$("#application").val();
		addQuestions(selected_application);
	}
});
$( "#application" ).focus(function() {
	$("#question_info").prop("selected",true);
	$("#question_list").children().not(':first').remove();
});


			// the button action
			$('#set_data_button').click(function () {
				var selected_year = document.getElementById("group_year").value
				$(".no_stats_info").remove();
				var categories=[];
				var sel_data=[];
				var chartType="";
				var question="";
				var xAxisTitle="Steps";
				var yAxisTitle="Seconds";
				var seriesName="Average time";
				
				/* !!!!!!!!!!!!!!!!!!!!! ADD YEAR !!!!!!!!!!!!!!!!!!!! */
				
				
				console.log("%%%%%%%%%%%%%%%%%%%"+selected_option);
				selected_application=$("#application").val();
				selected_group = document.getElementById("group_list").value;
				console.log(selected_application);
				console.log("!!!!!!!!!!!!!!!!!!"+selected_option);
				if(selected_option!="summary_data"){
					if(selected_option=="time"){
						chartType="line";
					}
					else if(selected_option=="class_steps"){
						console.log("TODO HISTOGRAM");
						xAxisTitle="Students";
						yAxisTitle="Time";
						seriesName="Time";
						chartType="column";
						console.log(step);

						$("#container").before("<button id='prev_step_button' onclick='getPrevStepData()'>Prev</button>");
						$("#container").before("<button id='next_step_button' onclick='getNextStepData()'>Next</button>");
						console.log(step);
					}
					else{
						xAxisTitle="Choices";
						yAxisTitle="Times chosen";
						seriesName="Times chosen";
						chartType="column";
						question=document.getElementById("question_list").value;
						console.log("#############"+question+"###################");
					}	
					console.log("CHART TYPE", chartType);
					var request = $.get('/exerciser/update_graph/', {app_name:selected_application, group:selected_group, info_type:selected_option,question:question, year:selected_year})
					//console.log("here");
					request.done(function(selected_data) {
						console.log("here");
						// when we get here, the request has succeeded.
						// this should mean that data is now the data from the ajax request (i.e. from the view above)

						console.log("sel" + sel_data);
						console.log("data " + sel_data);
						if(Object.getOwnPropertyNames(selected_data).length != 0){
							sel_data=selected_data["data"];
							questionSteps=selected_data["question_steps"];
							console.log(questionSteps);
							console.log("data>0");
							console.log(sel_data+"INITIAL DATA");
							if(selected_option=="time"){
								for (i = 0; i < sel_data.length; i++) { 
									if(questionSteps.indexOf(i)  != -1){
										categories[i]="? " + (i+1);
									}
									else{
										categories[i]=(i+1);
									}
								}
							}
							
							else{
								var option_categories=[];
								var option_data=[];
								for (i = 0; i < sel_data.length; i++) { 
									console.log(sel_data[i]+"SELDI");
									for (var option in sel_data[i]) {
										console.log(option+"OPTION");
										if ((typeof option)=="string" && option!="students"){
										  option_categories.push(option);
										
										  //console.log(option+"OPTION");
										  option_data.push({"y":sel_data[i][option],"students":sel_data[i]["students"]});
										}
									  
									  //console.log(sel_data[i][option]+"DATA");
									}
								}
								sel_data=option_data;
								categories=option_categories;
								console.log(sel_data);
								console.log(categories);

								
							}
							console.log(sel_data+"SELECTED DATA");			
							$('#container').highcharts({
											chart: {
												type: chartType
											},
											title: {
												text: selected_application + "- Group " + selected_group,
		
											},
											subtitle: {
												text: question
											},
											xAxis: {
												categories:categories,
												title:{
													text: xAxisTitle
												}
											},
											yAxis: {
												allowDecimals: false,
												title:{
													text: yAxisTitle
												}
											},
											
											plotOptions: {
												series: {
												
													dataLabels: {
													enabled: true,
													formatter: function(){
														if (selected_option == "time"){
															return Highcharts.numberFormat(this.y,1) + ' s (' + this.point.revisited_count + ')' 
														} 
														else if(selected_option == "answers"){
															return this.y + ' times'
														}
														else if (selected_option == "class_steps"){
															return Highcharts.numberFormat(this.y,1) + ' s'
														}
														else{
															return this.y
													}	}
													},

													cursor: 'pointer',
													point: {
														events: {
															click: function (e) {
																if(selected_option=="time"){
																	if(questionSteps.indexOf(this.x)!=-1){
																		hs.htmlExpand(null, {
																			pageOrigin: {
																				x: e.pageX || e.clientX,
																				y: e.pageY || e.clientY
																			},
																			headingText: this.series.name,
																			maincontentText: "	<div id='cont_"+count+"'> </div><br/> ",
																			width: 600,
																			height:330
																		});
																		getQuestionData(selected_application,selected_year,selected_group,this.x);
																	}
																	else{
																		hs.htmlExpand(null, {
																				pageOrigin: {
																					x: e.pageX || e.clientX,
																					y: e.pageY || e.clientY
																				},
																				headingText: "Step Explanation",
																				maincontentText: this.explanation
																			});
																	}
																}
															}
														}
													},
													marker: {
														lineWidth: 1
													}
												}
											},

											series: [{
												showInLegend: false,
												name: seriesName,
												data: sel_data,
											}],
											tooltip: {
												formatter: function() {
													if(selected_option=="time"){
														return ' ' +
														'Average time: ' + Highcharts.numberFormat(this.point.y, 1) +' s<br />'+
														'Revisited: ' + this.point.revisited_count + ' times<br />' +
														'Explanation: ' + this.point.explanation_start + '<br />';
													}
													else if (selected_option=="answers"){
														return 'Times Chosen: ' + this.point.y + '<br/>' +
														'Students: ' + this.point.students;
													}
													else if (selected_option=="class_steps"){
														return "Time: " + Highcharts.numberFormat(this.point.y,1) + " s";
													}
													else {
														return this.point.y;
													}
												}
												
											}
							});
							
							
							

						}
						
								
						else{
							$('#container').find('.highcharts-container').hide();
							$('#container').html("<div class='no_stats_info'><br\><br\><br\><br\><br\><br\><i class='fa fa-asterisk' style='color:red'></i><span style='color:red'>There are no statistics for the current selection</span><div>");
						}
					});
								
				}
				else{
					$(".student_info").remove();
					$("#summary_data_caption").empty();
					console.log("TODO TABLE");
					var selected_application="ClockExample";

					var request = $.get('/exerciser/populate_summary_table/', {application:selected_application, group:selected_group, year:2014})
					//console.log("here");
					//var summary_data;
					request.done(function(summary_data) {
						console.log("DONE");
						//summary_data=summary_data;
						//console.log(summary_data["total_steps"]+"total steps");
						for (student in summary_data["selected_data"]){
							$("#summary_data").append("<tr id='student_"+student+"' class='student_info'></tr>");
							var studentData = summary_data[student];
							$("#student_"+student).append("<td>" + student + "</td>");
							$("#student_"+student).append("<td>" + summary_data["selected_data"][student]["total_time"].toFixed(1) + "</td>");
							$("#student_"+student).append("<td>" + summary_data["selected_data"][student]["num_steps_revisited"] + "</td>");
							$("#student_"+student).append("<td>" + summary_data["selected_data"][student]["last_step"] + "</td>");
						
							//console.log(summary_data[student]);
							//console.log(summary_data[student]["total_time"]);
						}
						$("#summary_data_caption").append(selected_application + " (" + summary_data["total_steps"] + " steps)");

						
					});
					//console.log(summary_data);
					//$('#container').append("<table border='1'><tr><td>test</td></tr></table>");
					$("#summary_data").show();
				}

			});

		});

function getQuestionData(selected_application,selected_year,selected_group,selected_step){

	var request = $.get('/exerciser/question_graph/', {app_name:"HorizontalLines", group:selected_group,year:selected_year,step:selected_step});


	request.done(function(selected_data) {
		console.log("request done");
		if(Object.getOwnPropertyNames(selected_data).length != 0){
			sel_data=selected_data["data"];
			questionText=selected_data["question"];
			console.log(questionText);
			console.log("in custom");
			var option_categories=[];
			var option_data=[];
			for (i = 0; i < sel_data.length; i++) { 
				for (var option in sel_data[i]) {
					option_categories.push(option);
					console.log(option);
					option_data.push(sel_data[i][option]);
					console.log(sel_data[i][option]);
				}
			}
			sel_data=option_data;
			categories=option_categories;

       		$('#cont_'+count).highcharts({
				chart: {
					type: "column"
				},
				title: {
					text: selected_application + "- Group " + selected_group,
				},
				subtitle: {
					text: questionText
				},
				xAxis: {
					categories:option_categories,
					title:{
						text: "answers"
					}
				},
				yAxis: {
					title:{
						text: "Times chosen"
					}
				},
				series: [{
					showInLegend: false,
					name: "Times chosen",
					data: sel_data,
				}]
			});
			
	
		}
		count++;
	});

}		

function addQuestions(selected_application){
	//$("#question_list").empty();

	for (var question_index in app_questions_dict[selected_application]){
		var question = app_questions_dict[selected_application][question_index];
		var option="<option value='" + question +"' >"+question + "</option>";
		console.log(question);
		$("#question_list").append(option);
	}
}


 $(function() {


		$( "#application" ).autocomplete({minLength: 0,
		  source: applications
		}).focus(function() {
		$(this).autocomplete("search", "");});

});
	$('.year').on('change', function() {
		//alert("'#"+$(this).attr('id')+"'" + "'#"+$(".group").first().attr('id')+"'");
		//populateGroupList('"#'+$(this).attr('id')+'"','"#'+$(".group").first().attr('id')+'"');
		populateGroupList($(this).attr('id'),nextInDOM('.group', $(this)).attr('id'));
	});
function populateGroupList(year_element,group_element) {
			//var year_element="'#"+year+"'";
			//var group_element="'#"+group+"'";
			console.log(year_element+"r3wr");
			console.log(group_element+"sfa");
			$("#"+group_element).empty();
						console.log(1);
			var selected_year=$("#"+year_element).val();
						console.log(2);
			group_list = year_group_dict[selected_year];
			//$("#existing_groups").text("Existing groups: ");
			console.log(3);
			if(year_element=="year"){
				$(".existing_groups_list").empty();
			}
			for (i = 0; i < group_list.length; i++) {
				var group = group_list[i];
				$("#"+group_element).append( "<option value='" + group +"'>" + group + "</option>" );
				if(group_element=="group_entry"){
					$(".existing_groups_list").append("<span class='appended_groups'>" + group + " </span>");
				}
			}
			if (group_list.length==0){
				$(".existing_groups_list").append("<span class='appended_groups'>None</span>");
			}
		};

		
		
//delete if not using
 $("#s1").dropdownchecklist( { forceMultiple: true
    , onComplete: function(selector) {
        var values = "test ";
        for( i=0; i < selector.options.length; i++ ) {
            if (selector.options[i].selected && (selector.options[i].value != "")) {
                if ( values != "" ) values += ";";
                values += selector.options[i].value;
            }
        }
	  	alert( values );
    } 
	, onItemClick: function(checkbox, selector){
		var justChecked = checkbox.prop("checked");
		var checkCount = (justChecked) ? 1 : -1;
		for( i = 0; i < selector.options.length; i++ ){
			if ( selector.options[i].selected ) checkCount += 1;
		}
	    if ( checkCount > 3 ) {
			alert( "Limit is 3" );
			throw "too many";
		}
	}
});
		
		
//from here: http://stackoverflow.com/questions/12873027/jquery-forget-the-dom-structure-just-find-the-next-element-with-this-class/12873187#12873187
function nextInDOM(_selector, _subject) {
    var next = getNext(_subject);
    while(next.length != 0) {
        var found = searchFor(_selector, next);
        if(found != null) return found;
        next = getNext(next);
    }
    return null;
}
function getNext(_subject) {
    if(_subject.next().length > 0) return _subject.next();
    return getNext(_subject.parent());
}
function searchFor(_selector, _subject) {
    if(_subject.is(_selector)) return _subject;
    else {
        var found = null;
        _subject.children().each(function() {
            found = searchFor(_selector, $(this));
            if(found != null) return false;
        });
        return found;
    }
    return null; // will/should never get here
}
	</script>
{% endblock %}

