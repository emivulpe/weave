{% extends 'exerciser/teacher_interface_base.html' %}

{% block style %}
#container{
	min-width: 310px;
	height: 400px;
	margin: 0 auto;
}

{% endblock %}
{% block body_block %}

	<select id="group_list">
		{% for group in groups %}
			<option value="{{group.name}}">Group {{group.name}}</option>
		{% endfor %}
	</select>
	
	<select id="application_list">
		{% for application in applications %}
			<option id="id_{{application.name}}" value="{{application.name}}">{{application.name}}</option>
		{% endfor %}
	</select>
	
	<select id="statistics_options">
		<option value="time">Average Time</option>
		<option value="answers">Question Answers</option>
	</select>
	
	<button id="set_data_button" class="autocompare">Set new data</button>
	<i class="fa fa-info-circle"></i><span class="landing-text">Please select an application and a group you would like to view statistics for!</span>
	<div id="container"> </div>

{% endblock %}

{% block javascripts %}
	<script src="/static/js/highcharts.js"></script>
	<script src="/static/js/exporting.js"></script>	
	<script>
		{% autoescape off %}
		var app_questions_dict = {{app_questions_dict}};
		{% endautoescape %}
		var apps_without_questions=[];
		for (var application in app_questions_dict) {
			if (app_questions_dict[application].length == 0){
				apps_without_questions.push(application);
			}
		}
		console.log(apps_without_questions);
		
		var selected_option=document.getElementById("statistics_options").value;
		var selected_application=document.getElementById("application_list").value;
		var selected_group=document.getElementById("group_list").value;
		console.log(selected_option + selected_application + selected_group);
	
		$(function ($) {

			$('#application_list').on('change', function() {
				selected_application = document.getElementById("application_list").value;
				if(selected_option="answers"){
					$("#question_list").empty();
					addQuestions(selected_application);
				}
			});
			
			$('#group_list').on('change', function() {
				selected_group = document.getElementById("group_list").value;
			});
			
			$('#statistics_options').on('change', function() {
				selected_option = document.getElementById("statistics_options").value;
				if (this.value=="answers"){
					$( this ).after( "<select id='question_list' style='max-width:250px'>	</select>" );
					for (var index in apps_without_questions) {
							$("#id_"+apps_without_questions[index]).wrap('<span/>'); //hide it-no questions (cross-browser compatible)
					}
					$("#application_list > option:first").attr("selected", "selected"); 
					selected_application = document.getElementById("application_list").value;
					console.log("Sel app" + selected_application);
					console.log($("#application_list > option:first").val()+"FC");
					
					addQuestions(selected_application);
				}
				
				else{
					if ($("#question_list").length > 0){
						$("#question_list").remove();
					}
					
					for (var index in apps_without_questions) {
						$("#id_"+apps_without_questions[index]).unwrap(); //hide it-no questions (cross-browser compatible)
					}
				}
			});


			// the button action
			$('#set_data_button').click(function () {

				var categories=[];
				var sel_data=[];
				var chartType="";
				var question="";
				if(selected_option=="time"){
					chartType="line";
				}
				else{
					chartType="column";
					question=document.getElementById("question_list").value;
					console.log("#############"+question+"###################");
				}
				console.log("time");
				var request = $.get('/exerciser/update_graph/', {app_name:selected_application, group:selected_group, info_type:selected_option,question:question})
				//console.log("here");
				request.done(function(selected_data) {
					console.log("here");
					// when we get here, the request has succeeded.
					// this should mean that data is now the data from the ajax request (i.e. from the view above)
					sel_data=selected_data;
					console.log("sel" + sel_data);
					console.log("data " + sel_data);
					if(sel_data.length>0){
						console.log("data>0");
						for (i = 0; i < sel_data.length; i++) { 
							categories[i]=i+1;
						}
										
						$('#container').highcharts({
										chart: {
											type: chartType
										},
										title: {
											text: selected_application
										},
										subtitle: {
											text: "Group " + selected_group
										},
										xAxis: {
											categories:categories
										},
										series: [{
											data: sel_data
										}]
						});
					}
					
							
					else{
						$('#container').find('.highcharts-container').hide();
						$('#container').text("There are no statistics for the current selection");
					}
				});

			});
		});

		
function addQuestions(selected_application){
	for (var question_index in app_questions_dict[selected_application]){
		var question = app_questions_dict[selected_application][question_index];
		var option="<option value='" + question +"' >"+question + "</option>";
		console.log(question);
		$("#question_list").append(option);
	}
}
	</script>
{% endblock %}

